<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙØ§ÛŒÙ„ Ù¾Ú© | Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ v6.3</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background: #0f172a; color: #f8fafc; min-height: 100vh; margin: 0; scroll-behavior: smooth; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .modal { display: none; position: fixed; inset: 0; z-index: 100; align-items: center; justify-content: center; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); }
        .modal.active { display: flex; }
        .admin-panel-bg { background: rgba(15, 23, 42, 0.98); border: 2px solid #3b82f6; }
        .main-title { font-weight: 900; font-size: 5rem; line-height: 1.2; background: linear-gradient(to bottom, #fff, #64748b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; padding: 20px 0; }
        .close-btn { position: absolute; top: 20px; left: 20px; font-size: 40px; cursor: pointer; color: #94a3b8; z-index: 110; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .close-btn:hover { color: #ef4444; transform: rotate(90deg) scale(1.3); }
        button, .btn-animate { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        button:hover { transform: scale(1.05); }
        .tab-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .smart-scroll-btn { position: fixed; bottom: 30px; left: 30px; z-index: 90; padding: 12px 22px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); backdrop-filter: blur(12px); border-radius: 50px; display: flex; align-items: center; gap: 10px; color: #3b82f6; cursor: pointer; animation: pulse-blue 2s infinite; }
        @keyframes pulse-blue { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        .media-box { w-full h-48 bg-white rounded-2xl mb-4 overflow-hidden flex items-center justify-center; }
        video, img { max-width: 100%; max-height: 100%; object-fit: contain; }
    </style>
</head>
<body class="p-4 md:p-8 text-right" onload="initApp()">

    <div id="smartScroll" class="smart-scroll-btn" onclick="toggleScroll()">
        <span id="scrollText" class="text-sm font-bold">Ø¨Ø±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ†</span>
        <svg id="scrollIcon" class="w-5 h-5 rotate-180 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
    </div>

    <nav class="max-w-6xl mx-auto flex justify-between items-center mb-12 px-4 py-4 glass rounded-3xl">
        <div class="text-2xl font-black text-sky-400">FILE PACK</div>
        <div class="flex items-center gap-4">
            <div id="userGreeting" class="hidden md:block text-sm text-sky-200 font-bold"></div>
            <button id="userStatusBtn" onclick="handleUserStatus()" class="glass px-5 py-2 rounded-xl text-sm transition btn-animate text-white text-bold">ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
            <button onclick="openModal('adminLoginModal')" class="bg-blue-600 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg btn-animate">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</button>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8 min-h-[400px]" id="fileGrid"></main>

    <footer class="max-w-6xl mx-auto glass rounded-[3rem] p-10 mb-12 mt-20 text-center md:text-right border border-white/10 shadow-2xl">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
            <div><div class="text-xl font-black text-sky-400 mb-4">Ø¯Ø±Ø¨Ø§Ø±Ù‡ ÙØ§ÛŒÙ„ Ù¾Ú©</div><p class="text-xs text-gray-400 leading-relaxed">Ù…Ø±Ø¬Ø¹ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ Ù„Ø§ÛŒÙ‡ Ø¨Ø§Ø² Ø¨Ø§ Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ† Ú©ÛŒÙÛŒØª Ø¨Ø±Ø§ÛŒ Ø·Ø±Ø§Ø­Ø§Ù† Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ.</p></div>
            <div><div class="text-xl font-black text-sky-400 mb-4 font-bold">Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø¬Ù…ÙˆØ¹Ù‡</div><p class="text-sm text-white mb-1 font-bold">Ø³ÛŒØ¯ Ø¹Ù„ÛŒ Ø¹Ù„ÙˆÛŒ</p><p class="text-[10px] text-gray-500 uppercase tracking-tighter">Designed by File Pack Â© 2025</p></div>
            <div><div class="text-xl font-black text-sky-400 mb-4 font-bold">Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù…Ø§</div><div class="flex items-center justify-center md:justify-start gap-3"><span class="text-sm text-gray-400">ØªÙ„Ú¯Ø±Ø§Ù…:</span><a href="https://t.me/asedali9903" target="_blank" dir="ltr" class="glass bg-blue-600/10 text-blue-400 px-5 py-2 rounded-xl text-sm font-bold btn-animate border border-blue-500/20 tracking-wide">@asedali9903</a></div></div>
        </div>
    </footer>

    <div id="downloadModal" class="modal p-4"><div class="glass max-w-lg w-full p-8 rounded-[3rem] relative text-right"><span class="close-btn" onclick="closeModal('downloadModal')">&times;</span><div id="modalMediaContainer" class="w-full h-64 bg-white rounded-3xl mb-8 overflow-hidden border border-white/10 shadow-xl flex items-center justify-center"></div><div class="space-y-3 mb-4 font-bold text-sm" dir="ltr"><div class="flex justify-between items-center border-b border-white/5 pb-1"><span class="text-gray-500">File Name:</span><span id="modalFileName" class="text-white ml-4 text-right"></span></div><div class="flex justify-between items-center border-b border-white/5 pb-1"><span class="text-gray-500">File Type:</span><span id="modalFileType" class="text-white ml-4 text-right"></span></div><div class="flex justify-between items-center"><span class="text-gray-500">File Code:</span><span id="modalFileCode" class="text-sky-400 ml-4 font-black text-lg"></span></div></div><div class="text-gray-800 text-center tracking-[0.5em] my-4">-----------------</div><button onclick="processDownload()" class="btn-animate w-full py-5 bg-blue-600 text-white font-bold rounded-2xl shadow-lg">Ø¯Ø§Ù†Ù„ÙˆØ¯</button><p id="limitInfo" class="mt-4 text-center text-[10px] text-gray-500 font-bold"></p></div></div>
    
    <div id="dashboardModal" class="modal p-4"><div class="admin-panel-bg max-w-6xl w-full p-6 md:p-10 rounded-[3rem] overflow-hidden flex flex-col max-h-[95vh] relative shadow-2xl text-white text-sm text-center"><span class="close-btn" onclick="closeModal('dashboardModal')">&times;</span><h2 class="text-3xl font-black text-blue-400 mb-6 border-b border-blue-500/20 pb-4">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù‡ÙˆØ´Ù…Ù†Ø¯</h2><div class="flex flex-wrap gap-4 mb-6 justify-center"><button onclick="switchTab('users')" id="tabUsers" class="tab-btn active glass px-8 py-2 rounded-xl border border-blue-500/30">Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</button><button onclick="switchTab('files')" id="tabFiles" class="tab-btn glass px-8 py-2 rounded-xl border border-blue-500/30">ÙØ§ÛŒÙ„â€ŒÙ‡Ø§</button><button onclick="sendFullReportToTelegram()" class="bg-orange-600/80 text-white px-6 py-2 rounded-xl border border-orange-500 font-bold hover:bg-orange-500 btn-animate">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ ØªÙ„Ú¯Ø±Ø§Ù…</button></div><div id="sectionUsers" class="overflow-auto flex-1"><table class="w-full text-center"><thead><tr class="text-blue-300"><th>Ø±Ø¯ÛŒÙ</th><th>Ù†Ø§Ù…</th><th>Ø¢ÛŒØ¯ÛŒ</th><th>Ø´Ù…Ø§Ø±Ù‡</th><th>Ø³Ù‚Ù</th><th>ØªØ§Ø±ÛŒØ®Ú†Ù‡</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody id="adminUserTableBody"></tbody></table></div><div id="sectionFiles" class="hidden overflow-auto flex-1 text-sm"><button onclick="openAddFile()" class="mb-4 bg-blue-600 text-white px-6 py-2 rounded-xl font-bold shadow-lg">Ø§ÙØ²ÙˆØ¯Ù† ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯</button><table class="w-full text-center"><thead><tr class="text-blue-300"><th>ID</th><th>Ù†Ø§Ù… ÙØ§ÛŒÙ„</th><th>Ø¯Ø³ØªÙ‡</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody id="adminFileTableBody"></tbody></table></div></div></div>

    <div id="fileFormModal" class="modal p-4"><div class="glass max-w-md w-full p-8 rounded-[3rem] relative overflow-auto max-h-[90vh] text-center border-white/10 shadow-2xl"><span class="close-btn" onclick="closeModal('fileFormModal')">&times;</span><h2 id="fileFormTitle" class="text-2xl font-black mb-6 text-blue-400">Ù…Ø¯ÛŒØ±ÛŒØª ÙØ§ÛŒÙ„</h2><input type="text" id="fTitle" placeholder="Ù†Ø§Ù… ÙØ§ÛŒÙ„" class="glass w-full p-4 rounded-2xl mb-3 outline-none text-white text-center"><input type="text" id="fImg" placeholder="Ù„ÛŒÙ†Ú© (Ø¹Ú©Ø³ ÛŒØ§ ÙˆÛŒØ¯ÛŒÙˆ)" class="glass w-full p-4 rounded-2xl mb-3 outline-none text-left text-white" dir="ltr"><textarea id="fDesc" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª" class="glass w-full p-4 rounded-2xl mb-3 outline-none h-24 text-white text-center"></textarea><input type="text" id="fLink" placeholder="Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯" class="glass w-full p-4 rounded-2xl mb-3 outline-none text-left text-white" dir="ltr"><input type="text" id="fCat" placeholder="Ø¯Ø³ØªÙ‡ Ø¨Ù†Ø¯ÛŒ" class="glass w-full p-4 rounded-2xl mb-6 outline-none text-white text-center"><button onclick="saveFile()" class="btn-animate w-full py-4 bg-blue-600 text-white font-bold rounded-2xl shadow-lg">Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</button></div></div>

    <div id="loginModal" class="modal p-4"><div class="glass max-w-sm w-full p-10 rounded-[3rem] relative flex flex-col items-center text-center border-white/10 shadow-2xl"><span class="close-btn" onclick="closeModal('loginModal')">&times;</span><h2 class="text-2xl font-black mb-6 text-blue-400">ÙˆØ±ÙˆØ¯</h2><input type="text" id="loginUser" placeholder="Ø¢ÛŒØ¯ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…" class="glass w-full p-4 rounded-2xl mb-3 outline-none text-center text-white text-center"><input type="text" id="loginPhone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³" class="glass w-full p-4 rounded-2xl mb-6 outline-none text-center text-white text-center"><button onclick="handleUserLogin()" class="btn-animate w-full py-4 bg-blue-600 text-white font-bold rounded-2xl shadow-lg">ÙˆØ±ÙˆØ¯</button><div class="mt-6"><button onclick="closeModal('loginModal'); openModal('signupModal')" class="text-blue-400 text-sm font-bold block">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¬Ø¯ÛŒØ¯</button></div></div></div>
    <div id="signupModal" class="modal p-4"><div class="glass max-w-sm w-full p-10 rounded-[3rem] relative flex flex-col items-center text-center border-white/10 shadow-2xl"><span class="close-btn" onclick="closeModal('signupModal')">&times;</span><h2 class="text-3xl font-black mb-8 text-sky-400">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h2><div class="w-full space-y-4"><input type="text" id="regName" placeholder="Ù†Ø§Ù…" class="glass w-full p-4 rounded-2xl mb-3 outline-none text-white text-center"><input type="text" id="regUser" placeholder="Ø¢ÛŒØ¯ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…" class="glass w-full p-4 rounded-2xl mb-3 outline-none text-center text-white"><input type="text" id="regPhone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³" class="glass w-full p-4 rounded-2xl mb-6 outline-none text-center text-white"></div><button onclick="handleUserSignup()" class="btn-animate w-full py-4 mt-8 bg-sky-500 text-black font-extrabold rounded-2xl shadow-lg">Ø¹Ø¶ÙˆÛŒØª Ù†Ù‡Ø§ÛŒÛŒ</button></div></div>
    <div id="adminLoginModal" class="modal p-4"><div class="glass max-w-sm w-full p-8 rounded-[3rem] relative flex flex-col items-center text-center border-blue-500/30 shadow-2xl"><span class="close-btn" onclick="closeModal('adminLoginModal')">&times;</span><h2 class="text-2xl font-black mb-6 text-blue-400">ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±ÛŒØª</h2><input type="text" id="adminUser" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ" class="glass w-full p-4 rounded-2xl mb-3 outline-none text-center text-white"><input type="password" id="adminPass" placeholder="Ø±Ù…Ø² ÙˆØ±ÙˆØ¯" class="glass w-full p-4 rounded-2xl mb-6 outline-none text-center text-white"><button onclick="checkAdminAuth()" class="btn-animate w-full py-4 bg-blue-600 text-white font-bold rounded-2xl shadow-lg">ÙˆØ±ÙˆØ¯</button></div></div>
    <div id="historyModal" class="modal p-4"><div class="admin-panel-bg max-w-2xl w-full p-8 rounded-[3rem] relative flex flex-col max-h-[85vh] text-right"><span class="close-btn" onclick="closeModal('historyModal')">&times;</span><h2 class="text-2xl font-black mb-6 text-blue-400 text-center border-b border-blue-500/20 pb-4 text-white font-bold">ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¯Ø§Ù†Ù„ÙˆØ¯</h2><div id="historyContent" class="overflow-auto flex-1 pr-2 text-right"></div></div></div>
    <div id="editUserModal" class="modal p-4"><div class="admin-panel-bg max-w-sm w-full p-8 rounded-[3rem] relative text-center border-blue-500/20 shadow-2xl"><span class="close-btn" onclick="closeModal('editUserModal')">&times;</span><h2 class="text-2xl font-black mb-6 text-blue-400 text-white font-bold text-lg">Ø³Ù‚Ù Ø¯Ø§Ù†Ù„ÙˆØ¯</h2><input type="number" id="editLimit" class="glass w-full p-4 rounded-2xl mb-6 outline-none text-center font-bold text-sky-400"><button onclick="saveUserEdit()" class="btn-animate w-full py-4 bg-blue-600 text-white font-bold rounded-2xl shadow-lg">Ø«Ø¨Øª</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø§Ø¨Ø±ÛŒ Ø´Ù…Ø§
        const firebaseConfig = { databaseURL: "https://filepack-f88d1-default-rtdb.firebaseio.com/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ
        window.users = []; window.files = []; window.currentUser = null;
        let editingFileKey = null, editingUserPhone = null, currentLink = "";
        const BOT_TOKEN = '7900019888:AAE1svoVvUbbFvqNM0AL4S7-ow-Wt2n6yy8';
        const MY_CHAT_ID = '5971023799';
        const ADMIN_USER = 'asedali9903';
        const ADMIN_PASS = '1234567891';

        const fixNumbers = (str) => str.toString().replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d)).replace(/[Ù -Ù©]/g, d => 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d));
        function isVideo(url) { return /\.(mp4|webm|ogg|mov)$/i.test(url); }

        // Ù‡Ø³ØªÙ‡ Ù…Ø±Ú©Ø²ÛŒ: Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø²Ù†Ø¯Ù‡ Ø¨Ù‡ ØªØºÛŒÛŒØ±Ø§Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ (Ø­Ø°ÙØŒ Ø§Ø¶Ø§ÙÙ‡ØŒ ØªØºÛŒÛŒØ±)
        onValue(ref(db, 'files'), (snapshot) => {
            const data = snapshot.val();
            // ØªØ¨Ø¯ÛŒÙ„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ù‡ Ø¢Ø±Ø§ÛŒÙ‡ Ø¨Ø§ Ø­ÙØ¸ Ú©Ù„ÛŒØ¯Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª Ø¢Ù†ÛŒ
            window.files = data ? Object.entries(data).map(([key, val]) => ({...val, key})) : [];
            window.renderHomeFiles(); // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
            if (document.getElementById('tabFiles').classList.contains('active')) window.renderAdminFileTable();
        });

        // Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø²Ù†Ø¯Ù‡ Ø¨Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
        onValue(ref(db, 'users'), (snapshot) => {
            const data = snapshot.val();
            window.users = data ? Object.values(data) : [];
            // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù„Ø§Ú¯ÛŒÙ† Ø¨ÙˆØ¯ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§ØªØ´ Ø±Ø§ Ø¯Ø± Ù„Ø­Ø¸Ù‡ Ø¨Ø±ÙˆØ² Ú©Ù†
            if (window.currentUser) {
                const updated = window.users.find(u => u.phone === window.currentUser.phone);
                if (updated) { 
                    window.currentUser = updated; 
                    localStorage.setItem('filepack_session', JSON.stringify(updated)); 
                    window.updateUserUI(); 
                }
            }
            if (document.getElementById('tabUsers').classList.contains('active')) window.renderAdminUserTable();
        });

        window.initApp = () => {
            const session = localStorage.getItem('filepack_session');
            if (session) window.currentUser = JSON.parse(session);
            window.updateUserUI();
        };

        window.openModal = (id) => document.getElementById(id).classList.add('active');
        window.closeModal = (id) => {
            document.getElementById(id).classList.remove('active');
            if(id === 'downloadModal') document.getElementById('modalMediaContainer').innerHTML = '';
        };

        window.renderHomeFiles = () => {
            const grid = document.getElementById('fileGrid');
            grid.innerHTML = window.files.length === 0 ? '<div class="col-span-full text-center py-10 text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± ÙØ§ÛŒÙ„ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.</div>' : '';
            window.files.forEach((f, index) => {
                let mediaHtml = isVideo(f.img) 
                    ? `<video src="${f.img}" class="w-full h-full object-contain" muted loop onmouseover="this.play()" onmouseout="this.pause()"></video>`
                    : `<img src="${f.img}" class="w-full h-full object-contain">`;
                grid.innerHTML += `<div class="glass p-5 rounded-[2.5rem] file-item cursor-pointer group hover:border-blue-500 transition-all text-center" onclick="openDownloadModal(${index})">
                    <div class="w-full h-48 bg-white rounded-2xl mb-4 overflow-hidden flex items-center justify-center">${mediaHtml}</div>
                    <div class="text-[10px] text-gray-500 mb-1 font-bold uppercase text-white">CODE: ${f.id}</div>
                    <h3 class="font-bold text-lg mb-2 text-white">${f.title}</h3>
                    <p class="text-[11px] text-blue-400 font-bold mt-4 flex items-center justify-center gap-1">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯</p>
                </div>`;
            });
        };

        window.openDownloadModal = (index) => {
            const f = window.files[index];
            document.getElementById('modalFileName').innerText = f.title;
            document.getElementById('modalFileType').innerText = f.cat || 'General';
            document.getElementById('modalFileCode').innerText = f.id;
            currentLink = f.link;
            const container = document.getElementById('modalMediaContainer');
            container.innerHTML = isVideo(f.img) ? `<video src="${f.img}" class="w-full h-full object-contain" controls autoplay></video>` : `<img src="${f.img}" class="w-full h-full object-contain">`;
            if(window.currentUser) {
                const today = new Intl.DateTimeFormat('fa-IR').format(new Date());
                const countToday = (window.currentUser.lastDate === today) ? (window.currentUser.dailyHistory ? window.currentUser.dailyHistory.length : 0) : 0;
                document.getElementById('limitInfo').innerText = `Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ù…Ø±ÙˆØ²: ${countToday} Ø§Ø² ${window.currentUser.customLimit || 5}`;
            }
            window.openModal('downloadModal');
        };

        window.processDownload = () => {
            if(!window.currentUser) { window.closeModal('downloadModal'); window.openModal('loginModal'); return; }
            if(!currentLink || currentLink.trim() === "" || currentLink === "#") return alert("Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯ ÛŒØ§ÙØª Ù†Ø´Ø¯!");
            const today = new Intl.DateTimeFormat('fa-IR').format(new Date());
            const timeNow = new Intl.DateTimeFormat('fa-IR', { dateStyle: 'medium', timeStyle: 'short' }).format(new Date());
            let user = {...window.currentUser};
            if (user.lastDate !== today) { user.dailyHistory = []; user.lastDate = today; }
            if (!user.dailyHistory) user.dailyHistory = [];
            const fileCode = document.getElementById('modalFileCode').innerText;
            if (!user.dailyHistory.includes(fileCode)) {
                if (user.dailyHistory.length >= (user.customLimit || 5)) return alert('Ø³Ù‚Ù Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªÙ…Ø§Ù… Ø´Ø¯!');
                user.dailyHistory.push(fileCode);
            }
            if (!user.detailedHistory) user.detailedHistory = [];
            user.detailedHistory.push({ name: document.getElementById('modalFileName').innerText, code: fileCode, time: timeNow });
            update(ref(db, 'users/' + user.phone), user).then(() => {
                const a = document.createElement('a'); a.href = currentLink; a.target = '_blank'; a.click();
            });
        };

        window.openAddFile = () => {
            editingFileKey = null;
            document.getElementById('fileFormTitle').innerText = "Ø§ÙØ²ÙˆØ¯Ù† ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯";
            document.getElementById('fTitle').value = '';
            document.getElementById('fImg').value = '';
            document.getElementById('fDesc').value = '';
            document.getElementById('fLink').value = '';
            document.getElementById('fCat').value = '';
            window.openModal('fileFormModal');
        };

        window.saveFile = () => {
            const data = { 
                id: window.files.length + 1,
                title: document.getElementById('fTitle').value, 
                img: document.getElementById('fImg').value, 
                desc: document.getElementById('fDesc').value, 
                link: document.getElementById('fLink').value, 
                cat: document.getElementById('fCat').value 
            };
            if(editingFileKey) {
                update(ref(db, 'files/' + editingFileKey), data).then(() => { editingFileKey = null; window.closeModal('fileFormModal'); });
            } else {
                push(ref(db, 'files'), data).then(() => window.closeModal('fileFormModal'));
            }
        };

        window.renderAdminFileTable = () => {
            const tbody = document.getElementById('adminFileTableBody'); tbody.innerHTML = '';
            window.files.forEach((f) => {
                tbody.innerHTML += `<tr><td>#${f.id}</td><td class="text-white text-right">${f.title}</td><td>${f.cat}</td><td><button onclick="editFile('${f.key}')" class="text-sky-400 ml-3">ÙˆÛŒØ±Ø§ÛŒØ´</button><button onclick="deleteFile('${f.key}')" class="text-red-400">Ø­Ø°Ù</button></td></tr>`;
            });
        };

        window.editFile = (key) => {
            const f = window.files.find(x => x.key === key);
            editingFileKey = key;
            document.getElementById('fileFormTitle').innerText = "ÙˆÛŒØ±Ø§ÛŒØ´ ÙØ§ÛŒÙ„";
            document.getElementById('fTitle').value = f.title;
            document.getElementById('fImg').value = f.img;
            document.getElementById('fDesc').value = f.desc;
            document.getElementById('fLink').value = f.link;
            document.getElementById('fCat').value = f.cat;
            window.openModal('fileFormModal');
        };

        window.deleteFile = (key) => { if(confirm('Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ Ø¯Ø± ØªÙ…Ø§Ù…ÛŒ Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ Ø§Ø¹Ù…Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.')) remove(ref(db, 'files/' + key)); };

        window.renderAdminUserTable = () => {
            const tbody = document.getElementById('adminUserTableBody'); tbody.innerHTML = '';
            window.users.forEach((u, i) => {
                const countToday = (new Intl.DateTimeFormat('fa-IR').format(new Date()) === u.lastDate) ? (u.dailyHistory ? u.dailyHistory.length : 0) : 0;
                tbody.innerHTML += `<tr><td>${i+1}</td><td>${u.name}</td><td class="text-blue-400">@${u.telegram}</td><td class="text-gray-400 text-xs">${u.phone}</td><td class="text-sky-400 font-bold">${countToday}/${u.customLimit || 5}</td><td><button onclick="showHistory('${u.phone}')" class="text-blue-400 underline">ØªØ§Ø±ÛŒØ®Ú†Ù‡</button></td><td><button onclick="openEditUser('${u.phone}')" class="text-white bg-blue-600 px-3 py-1 rounded-lg text-xs">ÙˆÛŒØ±Ø§ÛŒØ´</button></td></tr>`;
            });
        };

        window.handleUserSignup = () => {
            const name = document.getElementById('regName').value.trim();
            const tUser = fixNumbers(document.getElementById('regUser').value.trim().replace('@',''));
            const tPhone = fixNumbers(document.getElementById('regPhone').value.trim());
            if(!name || !tUser || !tPhone) return alert('Ù‡Ù…Ù‡ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
            set(ref(db, 'users/' + tPhone), { name, telegram: tUser, phone: tPhone, lastDate: '', customLimit: 5, dailyHistory: [], detailedHistory: [] }).then(() => {
                alert('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚!'); window.closeModal('signupModal'); window.openModal('loginModal');
            });
        };

        window.handleUserLogin = () => {
            const uTeg = fixNumbers(document.getElementById('loginUser').value.trim().replace('@',''));
            const uPho = fixNumbers(document.getElementById('loginPhone').value.trim());
            const found = window.users.find(u => u.telegram.toLowerCase() === uTeg.toLowerCase() && u.phone === uPho);
            if(found) { window.currentUser = found; localStorage.setItem('filepack_session', JSON.stringify(found)); location.reload(); } else alert('ÛŒØ§ÙØª Ù†Ø´Ø¯!');
        };

        window.showHistory = (phone) => {
            const u = window.users.find(x => x.phone === phone);
            const container = document.getElementById('historyContent'); container.innerHTML = '';
            if (!u.detailedHistory) container.innerHTML = '<p class="text-center text-gray-500 mt-10">Ø®Ø§Ù„ÛŒ</p>';
            else [...u.detailedHistory].reverse().forEach((item, i) => {
                container.innerHTML += `<div class="history-card text-white text-right"><div class="flex flex-col gap-1 w-full"><span class="font-bold text-sm">${u.detailedHistory.length - i}. ${item.name}</span><span class="text-[10px] text-gray-400">Ú©Ø¯: ${item.code} | Ø²Ù…Ø§Ù†: ${item.time}</span></div></div>`;
            });
            window.openModal('historyModal');
        };

        window.openEditUser = (phone) => {
            editingUserPhone = phone;
            const u = window.users.find(x => x.phone === phone);
            document.getElementById('editLimit').value = u.customLimit || 5;
            window.openModal('editUserModal');
        };

        window.saveUserEdit = () => {
            update(ref(db, 'users/' + editingUserPhone), { customLimit: parseInt(document.getElementById('editLimit').value) }).then(() => window.closeModal('editUserModal'));
        };

        window.checkAdminAuth = () => {
            const u = fixNumbers(document.getElementById('adminUser').value.trim());
            const p = fixNumbers(document.getElementById('adminPass').value.trim());
            if(u === ADMIN_USER && p === ADMIN_PASS) { window.closeModal('adminLoginModal'); window.switchTab('users'); window.openModal('dashboardModal'); } else alert('Ø®Ø·Ø§!');
        };

        window.handleUserStatus = () => {
            if(window.currentUser) { localStorage.removeItem('filepack_session'); location.reload(); }
            else window.openModal('loginModal');
        };

        window.updateUserUI = () => {
            const btn = document.getElementById('userStatusBtn');
            const greet = document.getElementById('userGreeting');
            if(window.currentUser) { btn.innerText = 'Ø®Ø±ÙˆØ¬'; greet.innerText = `Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ØŒ ${window.currentUser.name}`; greet.classList.remove('hidden'); }
            else { btn.innerText = 'ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…'; greet.classList.add('hidden'); }
        };

        window.switchTab = (tab) => {
            document.getElementById('sectionUsers').classList.toggle('hidden', tab !== 'users');
            document.getElementById('sectionFiles').classList.toggle('hidden', tab !== 'files');
            document.getElementById('tabUsers').classList.toggle('active', tab === 'users');
            document.getElementById('tabFiles').classList.toggle('active', tab === 'files');
            if(tab === 'users') window.renderAdminUserTable(); else window.renderAdminFileTable();
        };

        window.sendFullReportToTelegram = () => {
            let msg = "ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ø§Ø¨Ø±ÛŒ ÙØ§ÛŒÙ„ Ù¾Ú©\n\n";
            window.users.forEach((u, i) => msg += `${i+1}. ${u.name} (@${u.telegram})\n`);
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: MY_CHAT_ID, text: msg }) });
            alert('Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.');
        };

        // Ø§Ø³Ú©Ø±ÙˆÙ„ Ùˆ Ø¬Ø³ØªØ¬Ùˆ
        window.toggleScroll = () => {
            if (window.scrollY > 300) window.scrollTo({ top: 0, behavior: 'smooth' });
            else window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        };

        window.addEventListener('scroll', () => {
            const btnText = document.getElementById('scrollText');
            if (window.scrollY > 300) btnText.innerText = 'Ø¨Ø±ÛŒÙ… Ø¨Ø§Ù„Ø§'; else btnText.innerText = 'Ø¨Ø±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ†';
        });

        window.liveSearch = () => {
            let val = document.getElementById('mainSearch').value.toLowerCase();
            let items = document.getElementsByClassName('file-item');
            for(let item of items) item.style.display = item.innerText.toLowerCase().includes(val) ? "block" : "none";
        };

    </script>
</body>
</html>
