<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فایل پک | نسخه متوازن v7.1</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background: #0f172a; color: #f8fafc; min-height: 100vh; margin: 0; scroll-behavior: smooth; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .modal { display: none; position: fixed; inset: 0; z-index: 100; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); backdrop-filter: blur(12px); padding: 20px; }
        .modal.active { display: flex; }
        .admin-panel-bg { background: rgba(15, 23, 42, 0.98); border: 1px solid #3b82f6; }
        .main-title { font-weight: 900; font-size: 3rem; line-height: 1.2; background: linear-gradient(to bottom, #fff, #64748b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; padding: 20px 0; }
        @media (min-width: 768px) { .main-title { font-size: 5rem; } }
        .close-btn { position: absolute; top: 1.5rem; left: 1.5rem; font-size: 2rem; cursor: pointer; color: #94a3b8; line-height: 1; transition: 0.3s; }
        .close-btn:hover { color: #ef4444; transform: scale(1.2); }
        button, .btn-animate { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .tab-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        /* استایل یکسان برای تمام اینپوت‌ها */
        .input-standard { width: 100%; padding: 1rem; border-radius: 1rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); outline: none; text-align: center; color: white; transition: 0.3s; }
        .input-standard:focus { border-color: #3b82f6; background: rgba(59, 130, 246, 0.05); }
        .smart-scroll-btn { position: fixed; bottom: 30px; left: 30px; z-index: 90; padding: 12px 24px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); backdrop-filter: blur(12px); border-radius: 50px; display: flex; align-items: center; gap: 8px; color: #3b82f6; cursor: pointer; animation: pulse-blue 2s infinite; }
        @keyframes pulse-blue { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 12px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        .hidden-fields { position: absolute; top: -1000px; left: -1000px; opacity: 0; }
    </style>
</head>
<body class="p-4 md:p-8" onload="initApp()">

    <div class="hidden-fields"><input type="text"><input type="password"></div>

    <div id="smartScroll" class="smart-scroll-btn" onclick="toggleScroll()">
        <span id="scrollText" class="text-xs font-bold">بریم پایین</span>
        <svg id="scrollIcon" class="w-4 h-4 rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
    </div>

    <nav class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center mb-16 px-6 py-5 glass rounded-[2rem] gap-4 shadow-xl">
        <div class="text-2xl font-black text-sky-400 tracking-tighter">FILE PACK</div>
        <div class="flex items-center gap-4">
            <div id="userGreeting" class="text-xs md:text-sm text-sky-200 font-bold"></div>
            <button id="userStatusBtn" onclick="handleUserStatus()" class="glass px-6 py-2.5 rounded-xl text-xs font-bold btn-animate border-white/10">ورود / ثبت‌نام</button>
            <button onclick="openModal('adminLoginModal')" class="bg-blue-600 px-6 py-2.5 rounded-xl text-xs font-bold shadow-lg btn-animate">مدیریت</button>
        </div>
    </nav>

    <header class="max-w-6xl mx-auto text-center mb-20">
        <h1 class="main-title">فایل پک</h1>
        <div class="max-w-xl mx-auto mt-8 px-4">
            <input type="text" id="v71_search" oninput="liveSearch()" autocomplete="new-password" placeholder="جستجو میان فایل‌ها..." 
                   class="input-standard py-5 text-xl shadow-2xl rounded-2xl">
        </div>
    </header>

    <main class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8 min-h-[400px]" id="fileGrid"></main>

    <footer class="max-w-6xl mx-auto glass rounded-[3rem] p-12 mb-12 mt-24 text-center border border-white/5 shadow-2xl">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-12 items-start">
            <div><div class="text-xl font-black text-sky-400 mb-6">درباره فایل پک</div><p class="text-xs text-gray-400 leading-relaxed text-justify">مرجع دانلود فایل‌های گرافیکی لایه باز با بالاترین کیفیت برای طراحان حرفه‌ای در ایران.</p></div>
            <div><div class="text-xl font-black text-sky-400 mb-6 font-bold">مدیریت مجموعه</div><p class="text-sm text-white mb-2 font-bold">سید علی علوی</p><p class="text-[10px] text-gray-500 uppercase">Designed by File Pack © 2025</p></div>
            <div><div class="text-xl font-black text-sky-400 mb-6 font-bold">ارتباط با ما</div><div class="flex items-center justify-center gap-3"><span class="text-sm text-gray-400">تلگرام:</span><a href="https://t.me/asedali9903" target="_blank" class="glass bg-blue-600/10 text-blue-400 px-6 py-2.5 rounded-xl text-sm font-bold border border-blue-500/20 btn-animate">@asedali9903</a></div></div>
        </div>
    </footer>

    <div id="loginModal" class="modal">
        <div class="glass max-w-sm w-full p-10 rounded-[2.5rem] relative flex flex-col items-center">
            <span class="close-btn" onclick="closeModal('loginModal')">&times;</span>
            <h2 class="text-2xl font-black mb-8 text-blue-400">ورود</h2>
            <div class="w-full space-y-4">
                <input type="text" id="v71_login_id" autocomplete="new-password" placeholder="آیدی تلگرام" class="input-standard">
                <input type="text" id="v71_login_phone" autocomplete="new-password" placeholder="شماره تماس" class="input-standard">
            </div>
            <div class="flex items-center gap-3 my-6 w-full justify-center">
                <input type="checkbox" id="v71_rem" class="w-4 h-4 rounded">
                <label for="v71_rem" class="text-xs text-gray-400">مرا به خاطر بسپار</label>
            </div>
            <button onclick="handleUserLogin()" class="w-full py-4 bg-blue-600 rounded-2xl font-bold shadow-lg btn-animate">ورود نهایی</button>
            <button onclick="closeModal('loginModal'); openModal('signupModal')" class="mt-6 text-blue-400 text-xs font-bold underline">ثبت‌نام جدید</button>
        </div>
    </div>

    <div id="signupModal" class="modal">
        <div class="glass max-w-sm w-full p-10 rounded-[2.5rem] relative flex flex-col items-center">
            <span class="close-btn" onclick="closeModal('signupModal')">&times;</span>
            <h2 class="text-2xl font-black mb-8 text-sky-400">عضویت</h2>
            <div class="w-full space-y-4">
                <input type="text" id="v71_reg_n" placeholder="نام کامل" class="input-standard">
                <input type="text" id="v71_reg_u" placeholder="آیدی تلگرام" class="input-standard">
                <input type="text" id="v71_reg_p" placeholder="شماره تماس" class="input-standard">
            </div>
            <button onclick="handleUserSignup()" class="w-full py-4 mt-8 bg-sky-500 text-black font-black rounded-2xl shadow-lg btn-animate">تایید عضویت</button>
        </div>
    </div>

    <div id="downloadModal" class="modal">
        <div class="glass max-w-lg w-full p-8 rounded-[3rem] relative text-center">
            <span class="close-btn" onclick="closeModal('downloadModal')">&times;</span>
            <div id="modalMediaContainer" class="w-full h-64 bg-white/5 rounded-3xl mb-8 overflow-hidden flex items-center justify-center border border-white/10 shadow-inner"></div>
            <div class="grid grid-cols-2 gap-4 mb-8 text-sm px-4">
                <div class="text-right text-gray-400">نام فایل:</div><div id="modalFileName" class="text-left font-bold text-white"></div>
                <div class="text-right text-gray-400">فرمت:</div><div id="modalFileType" class="text-left font-bold text-white"></div>
                <div class="text-right text-gray-400">کد محصول:</div><div id="modalFileCode" class="text-left font-black text-sky-400"></div>
            </div>
            <button onclick="processDownload()" class="w-full py-5 bg-blue-600 rounded-2xl font-black text-lg shadow-xl btn-animate">دانلود رایگان</button>
            <p id="limitInfo" class="mt-4 text-[10px] text-gray-500 font-bold"></p>
        </div>
    </div>

    <div id="dashboardModal" class="modal">
        <div class="admin-panel-bg max-w-5xl w-full p-8 rounded-[3rem] max-h-[90vh] flex flex-col relative text-center">
            <span class="close-btn" onclick="closeModal('dashboardModal')">&times;</span>
            <h2 class="text-2xl font-black text-blue-400 mb-8 pb-4 border-b border-blue-500/20">مدیریت فایل پک</h2>
            <div class="flex gap-4 mb-8 justify-center">
                <button onclick="switchTab('users')" id="tabUsers" class="tab-btn active glass px-8 py-2.5 rounded-xl border border-blue-500/30 font-bold">لیست کاربران</button>
                <button onclick="switchTab('files')" id="tabFiles" class="tab-btn glass px-8 py-2.5 rounded-xl border border-blue-500/30 font-bold">لیست فایل‌ها</button>
            </div>
            <div id="sectionUsers" class="overflow-auto flex-1">
                <table class="w-full border-separate border-spacing-y-2">
                    <thead class="text-sky-400 text-xs"><tr><th>#</th><th>نام</th><th>تلگرام</th><th>شماره</th><th>سقف</th><th>عملیات</th></tr></thead>
                    <tbody id="adminUserTableBody" class="text-xs"></tbody>
                </table>
            </div>
            <div id="sectionFiles" class="hidden overflow-auto flex-1">
                <button onclick="openAddFile()" class="mb-6 bg-blue-600 px-8 py-3 rounded-xl font-bold shadow-lg">افزودن محصول جدید</button>
                <table class="w-full border-separate border-spacing-y-2">
                    <thead class="text-sky-400 text-xs"><tr><th>ID</th><th>عنوان فایل</th><th>دسته</th><th>مدیریت</th></tr></thead>
                    <tbody id="adminFileTableBody" class="text-xs"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="fileFormModal" class="modal">
        <div class="glass max-w-md w-full p-10 rounded-[2.5rem] relative flex flex-col items-center">
            <span class="close-btn" onclick="closeModal('fileFormModal')">&times;</span>
            <h2 id="fileFormTitle" class="text-2xl font-black mb-8 text-blue-400">ثبت محصول</h2>
            <div class="w-full space-y-4">
                <input type="text" id="fTitle" placeholder="نام محصول" class="input-standard">
                <input type="text" id="fImg" placeholder="لینک پیش‌نمایش (تلگراف)" class="input-standard" dir="ltr">
                <textarea id="fDesc" placeholder="توضیحات کوتاه" class="input-standard h-24 py-3"></textarea>
                <input type="text" id="fLink" placeholder="لینک دانلود مستقیم" class="input-standard" dir="ltr">
                <input type="text" id="fCat" placeholder="دسته‌بندی (مثلاً: لوگو)" class="input-standard">
            </div>
            <button onclick="saveFile()" class="w-full py-4 mt-8 bg-blue-600 rounded-2xl font-bold shadow-lg btn-animate">ذخیره اطلاعات</button>
        </div>
    </div>

    <div id="adminLoginModal" class="modal">
        <div class="glass max-w-sm w-full p-10 rounded-[2.5rem] relative flex flex-col items-center">
            <span class="close-btn" onclick="closeModal('adminLoginModal')">&times;</span>
            <h2 class="text-2xl font-black mb-8 text-blue-400">ورود ادمین</h2>
            <div class="w-full space-y-4">
                <input type="text" id="v71_admin_u" autocomplete="new-password" placeholder="نام کاربری" class="input-standard">
                <input type="password" id="v71_admin_p" autocomplete="new-password" placeholder="رمز عبور" class="input-standard">
            </div>
            <button onclick="checkAdminAuth()" class="w-full py-4 mt-8 bg-blue-600 rounded-2xl font-bold btn-animate">تایید هویت</button>
        </div>
    </div>

    <div id="historyModal" class="modal"><div class="admin-panel-bg max-w-lg w-full p-8 rounded-[2.5rem] relative flex flex-col max-h-[80vh] text-center"><span class="close-btn" onclick="closeModal('historyModal')">&times;</span><h2 class="text-xl font-black mb-6 text-blue-400 border-b border-white/10 pb-4">آخرین دانلودها</h2><div id="historyContent" class="overflow-auto flex-1"></div></div></div>
    <div id="editUserModal" class="modal"><div class="admin-panel-bg max-w-sm w-full p-10 rounded-[2.5rem] relative text-center"><span class="close-btn" onclick="closeModal('editUserModal')">&times;</span><h2 class="text-xl font-black mb-6 text-sky-400">تغییر سقف دانلود</h2><input type="number" id="editLimit" class="input-standard text-3xl font-black text-sky-400 mb-8"><button onclick="saveUserEdit()" class="w-full py-4 bg-blue-600 rounded-2xl font-bold">ثبت نهایی</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://filepack-f88d1-default-rtdb.firebaseio.com/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.users = []; window.files = []; window.currentUser = null;
        let editingFileKey = null, editingUserPhone = null, currentLink = "";
        const ADMIN_USER = 'asedali9903';
        const ADMIN_PASS = '1234567891';

        const fixNumbers = (str) => str.toString().replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d)).replace(/[٠-٩]/g, d => '٠١٢٣٤٥٦٧٨٩'.indexOf(d));
        function isVideo(url) { return /\.(mp4|webm|ogg|mov)$/i.test(url); }

        window.openModal = (id) => document.getElementById(id).classList.add('active');
        window.closeModal = (id) => { document.getElementById(id).classList.remove('active'); if(id === 'downloadModal') document.getElementById('modalMediaContainer').innerHTML = ''; };

        // همگام‌سازی ابری فایل‌ها و کاربران
        onValue(ref(db, 'files'), (snapshot) => {
            const data = snapshot.val();
            window.files = data ? Object.entries(data).map(([key, val]) => ({...val, key})) : [];
            window.renderHomeFiles();
            if (document.getElementById('tabFiles').classList.contains('active')) window.renderAdminFileTable();
        });

        onValue(ref(db, 'users'), (snapshot) => {
            const data = snapshot.val();
            window.users = data ? Object.values(data) : [];
            if (window.currentUser) {
                const updated = window.users.find(u => u.phone === window.currentUser.phone);
                if (updated) { window.currentUser = updated; window.updateUserUI(); }
            }
            if (document.getElementById('tabUsers').classList.contains('active')) window.renderAdminUserTable();
        });

        window.renderHomeFiles = () => {
            const grid = document.getElementById('fileGrid');
            grid.innerHTML = window.files.length === 0 ? '<div class="col-span-full text-center py-20 text-gray-600">هنوز محصولی ثبت نشده است.</div>' : '';
            window.files.forEach((f, index) => {
                let mediaHtml = isVideo(f.img) 
                    ? `<video src="${f.img}" class="w-full h-full object-contain" muted loop onmouseover="this.play()" onmouseout="this.pause()"></video>`
                    : `<img src="${f.img}" class="w-full h-full object-contain">`;
                grid.innerHTML += `<div class="glass p-6 rounded-[2.5rem] file-item group hover:border-blue-500 transition-all cursor-pointer flex flex-col h-full" onclick="openDownloadModal(${index})">
                    <div class="w-full h-48 bg-white/5 rounded-2xl mb-6 overflow-hidden flex items-center justify-center">${mediaHtml}</div>
                    <div class="text-[10px] text-gray-500 font-bold mb-2">CODE: ${f.id}</div>
                    <h3 class="font-bold text-lg text-white mb-4 line-clamp-1">${f.title}</h3>
                    <div class="mt-auto py-3 border-t border-white/5 text-[11px] text-blue-400 font-bold tracking-wide">جزئیات و دانلود مستقیم</div>
                </div>`;
            });
        };

        window.openDownloadModal = (index) => {
            const f = window.files[index];
            document.getElementById('modalFileName').innerText = f.title;
            document.getElementById('modalFileType').innerText = f.cat || 'Graphic';
            document.getElementById('modalFileCode').innerText = f.id;
            currentLink = f.link;
            const container = document.getElementById('modalMediaContainer');
            container.innerHTML = isVideo(f.img) ? `<video src="${f.img}" class="w-full h-full object-contain" controls autoplay></video>` : `<img src="${f.img}" class="w-full h-full object-contain">`;
            window.updateUserUI();
            window.openModal('downloadModal');
        };

        window.processDownload = () => {
            if(!window.currentUser) { window.closeModal('downloadModal'); window.openModal('loginModal'); return; }
            if(!currentLink) return alert('لینک دانلود یافت نشد!');
            const today = new Intl.DateTimeFormat('fa-IR').format(new Date());
            let user = {...window.currentUser};
            if (user.lastDate !== today) { user.dailyHistory = []; user.lastDate = today; }
            const fileCode = document.getElementById('modalFileCode').innerText;
            if (!(user.dailyHistory || []).includes(fileCode)) {
                if ((user.dailyHistory || []).length >= (user.customLimit || 5)) return alert('سقف دانلود روزانه تمام شد!');
                if (!user.dailyHistory) user.dailyHistory = [];
                user.dailyHistory.push(fileCode);
            }
            if (!user.detailedHistory) user.detailedHistory = [];
            user.detailedHistory.push({ name: document.getElementById('modalFileName').innerText, code: fileCode, time: new Date().toLocaleTimeString('fa-IR') });
            update(ref(db, 'users/' + user.phone), user).then(() => { const a = document.createElement('a'); a.href = currentLink; a.target = '_blank'; a.click(); });
        };

        window.handleUserLogin = () => {
            const uT = fixNumbers(document.getElementById('v71_login_id').value.trim().replace('@',''));
            const uP = fixNumbers(document.getElementById('v71_login_phone').value.trim());
            const rem = document.getElementById('v71_rem').checked;
            const found = window.users.find(u => u.telegram.toLowerCase() === uT.toLowerCase() && u.phone === uP);
            if(found) { 
                window.currentUser = found; 
                (rem ? localStorage : sessionStorage).setItem('filepack_session', JSON.stringify(found));
                location.reload(); 
            } else alert('اطلاعات یافت نشد!');
        };

        window.handleUserSignup = () => {
            const n = document.getElementById('v71_reg_n').value.trim();
            const u = fixNumbers(document.getElementById('v71_reg_u').value.trim().replace('@',''));
            const p = fixNumbers(document.getElementById('v71_reg_p').value.trim());
            if(!n || !u || !p) return alert('تمام فیلدها را پر کنید');
            set(ref(db, 'users/' + p), { name: n, telegram: u, phone: p, lastDate: '', customLimit: 5, dailyHistory: [], detailedHistory: [] }).then(() => { alert('ثبت‌نام موفق! حالا وارد شوید.'); location.reload(); });
        };

        window.checkAdminAuth = () => {
            const u = fixNumbers(document.getElementById('v71_admin_u').value.trim());
            const p = fixNumbers(document.getElementById('v71_admin_p').value.trim());
            if(u === ADMIN_USER && p === ADMIN_PASS) { window.closeModal('adminLoginModal'); window.switchTab('users'); window.openModal('dashboardModal'); } else alert('خطا!');
        };

        // مدیریت پنل ادمین
        window.renderAdminUserTable = () => {
            const tbody = document.getElementById('adminUserTableBody'); tbody.innerHTML = '';
            window.users.forEach((u, i) => {
                const count = (new Intl.DateTimeFormat('fa-IR').format(new Date()) === u.lastDate) ? (u.dailyHistory ? u.dailyHistory.length : 0) : 0;
                tbody.innerHTML += `<tr class="bg-white/5"><td>${i+1}</td><td>${u.name}</td><td class="text-blue-400">@${u.telegram}</td><td>${u.phone}</td><td class="text-sky-400 font-bold">${count}/${u.customLimit || 5}</td><td><button onclick="showHistory('${u.phone}')" class="underline ml-3">تاریخچه</button><button onclick="openEditUser('${u.phone}')" class="bg-blue-600 px-2 py-1 rounded">ویرایش</button></td></tr>`;
            });
        };

        window.renderAdminFileTable = () => {
            const tbody = document.getElementById('adminFileTableBody'); tbody.innerHTML = '';
            window.files.forEach((f) => {
                tbody.innerHTML += `<tr class="bg-white/5"><td>#${f.id}</td><td class="text-white font-bold">${f.title}</td><td>${f.cat}</td><td><button onclick="editFile('${f.key}')" class="text-sky-400 ml-4">ویرایش</button><button onclick="deleteFile('${f.key}')" class="text-red-400">حذف</button></td></tr>`;
            });
        };

        window.saveFile = () => {
            const data = { id: window.files.length + 1, title: document.getElementById('fTitle').value, img: document.getElementById('fImg').value, desc: document.getElementById('fDesc').value, link: document.getElementById('fLink').value, cat: document.getElementById('fCat').value };
            if(editingFileKey) update(ref(db, 'files/' + editingFileKey), data).then(() => { editingFileKey = null; window.closeModal('fileFormModal'); });
            else push(ref(db, 'files'), data).then(() => window.closeModal('fileFormModal'));
        };

        window.editFile = (key) => { const f = window.files.find(x => x.key === key); editingFileKey = key; document.getElementById('fTitle').value = f.title; document.getElementById('fImg').value = f.img; document.getElementById('fDesc').value = f.desc; document.getElementById('fLink').value = f.link; document.getElementById('fCat').value = f.cat; window.openModal('fileFormModal'); };
        window.deleteFile = (key) => { if(confirm('حذف شود؟')) remove(ref(db, 'files/' + key)); };
        window.openAddFile = () => { editingFileKey = null; document.getElementById('fTitle').value = ''; document.getElementById('fImg').value = ''; document.getElementById('fDesc').value = ''; document.getElementById('fLink').value = ''; document.getElementById('fCat').value = ''; window.openModal('fileFormModal'); };
        window.showHistory = (phone) => { const u = window.users.find(x => x.phone === phone); const container = document.getElementById('historyContent'); container.innerHTML = ''; if (!u.detailedHistory) container.innerHTML = '<p class="py-10 text-gray-600 text-center">خالی</p>'; else [...u.detailedHistory].reverse().forEach((item, i) => { container.innerHTML += `<div class="bg-white/5 p-4 rounded-2xl mb-2 text-right"><div class="font-bold text-white text-sm">${item.name}</div><div class="text-[10px] text-gray-500 mt-1">${item.time}</div></div>`; }); window.openModal('historyModal'); };
        window.openEditUser = (phone) => { editingUserPhone = phone; const u = window.users.find(x => x.phone === phone); document.getElementById('editLimit').value = u.customLimit || 5; window.openModal('editUserModal'); };
        window.saveUserEdit = () => { update(ref(db, 'users/' + editingUserPhone), { customLimit: parseInt(document.getElementById('editLimit').value) }).then(() => window.closeModal('editUserModal')); };

        window.handleUserStatus = () => { if(window.currentUser) { localStorage.removeItem('filepack_session'); sessionStorage.removeItem('filepack_session'); location.reload(); } else window.openModal('loginModal'); };
        window.updateUserUI = () => {
            const btn = document.getElementById('userStatusBtn'); const greet = document.getElementById('userGreeting'); const limitInfo = document.getElementById('limitInfo');
            if(window.currentUser) { btn.innerText = 'خروج'; greet.innerText = "خوش آمدید، " + window.currentUser.name; const today = new Intl.DateTimeFormat('fa-IR').format(new Date()); const count = (window.currentUser.lastDate === today) ? (window.currentUser.dailyHistory ? window.currentUser.dailyHistory.length : 0) : 0; if(limitInfo) limitInfo.innerText = `دانلود امروز: ${count} از ${window.currentUser.customLimit || 5}`; } 
            else { btn.innerText = 'ورود / ثبت‌نام'; greet.innerText = ""; if(limitInfo) limitInfo.innerText = "برای دانلود باید وارد شوید"; }
        };
        window.switchTab = (tab) => { document.getElementById('sectionUsers').classList.toggle('hidden', tab !== 'users'); document.getElementById('sectionFiles').classList.toggle('hidden', tab !== 'files'); document.getElementById('tabUsers').classList.toggle('active', tab === 'users'); document.getElementById('tabFiles').classList.toggle('active', tab === 'files'); if(tab === 'users') window.renderAdminUserTable(); else window.renderAdminFileTable(); };
        window.initApp = () => { const session = localStorage.getItem('filepack_session') || sessionStorage.getItem('filepack_session'); if (session) window.currentUser = JSON.parse(session); window.updateUserUI(); };

    </script>
    <script>
        function toggleScroll() { if (window.scrollY > 300) window.scrollTo({ top: 0, behavior: 'smooth' }); else window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }
        window.addEventListener('scroll', () => { const btnText = document.getElementById('scrollText'); if (window.scrollY > 300) btnText.innerText = 'بریم بالا'; else btnText.innerText = 'بریم پایین'; });
        function liveSearch() { let val = document.getElementById('v71_search').value.toLowerCase(); let items = document.getElementsByClassName('file-item'); for(let item of items) item.style.display = item.innerText.toLowerCase().includes(val) ? "block" : "none"; }
    </script>
</body>
</html>
