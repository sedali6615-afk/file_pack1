<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙØ§ÛŒÙ„ Ù¾Ú© | Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ù‡ÙˆØ´Ù…Ù†Ø¯ v5.1</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background: #0f172a; color: #f8fafc; min-height: 100vh; margin: 0; scroll-behavior: smooth; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .modal { display: none; position: fixed; inset: 0; z-index: 100; align-items: center; justify-content: center; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); }
        .modal.active { display: flex; }
        .admin-panel-bg { background: rgba(15, 23, 42, 0.98); border: 2px solid #3b82f6; }
        .main-title { font-weight: 900; font-size: 5rem; line-height: 1.2; background: linear-gradient(to bottom, #fff, #64748b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; padding: 20px 0; }
        .close-btn { position: absolute; top: 20px; left: 20px; font-size: 40px; cursor: pointer; color: #94a3b8; z-index: 110; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .close-btn:hover { color: #ef4444; transform: rotate(90deg) scale(1.3); }
        button, .btn-animate { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        button:hover, .btn-animate:hover { transform: scale(1.05); box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3); }
        .tab-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .smart-scroll-btn { position: fixed; bottom: 30px; left: 30px; z-index: 90; padding: 12px 22px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); backdrop-filter: blur(12px); border-radius: 50px; display: flex; align-items: center; gap: 10px; color: #3b82f6; cursor: pointer; animation: pulse-blue 2s infinite; }
        @keyframes pulse-blue { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        .history-card { border: 1px solid rgba(59, 130, 246, 0.2); background: rgba(255, 255, 255, 0.02); padding: 15px; border-radius: 20px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        video, img { max-width: 100%; max-height: 100%; object-fit: contain; }
    </style>
</head>
<body class="p-4 md:p-8 text-right" onload="initApp()">

    <div id="smartScroll" class="smart-scroll-btn" onclick="toggleScroll()">
        <span id="scrollText" class="text-sm font-bold">Ø¨Ø±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ†</span>
        <svg id="scrollIcon" class="w-5 h-5 rotate-180 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
    </div>

    <nav class="max-w-6xl mx-auto flex justify-between items-center mb-12 px-4 py-4 glass rounded-3xl">
        <div class="text-2xl font-black text-sky-400">FILE PACK</div>
        <div class="flex items-center gap-4">
            <div id="userGreeting" class="hidden md:block text-sm text-sky-200 font-bold"></div>
            <button id="userStatusBtn" onclick="openModal('loginModal')" class="glass px-5 py-2 rounded-xl text-sm transition btn-animate text-white">ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
            <button onclick="openModal('adminLoginModal')" class="bg-blue-600 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg btn-animate">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</button>
        </div>
    </nav>

    <header class="max-w-6xl mx-auto text-center mb-16">
        <h1 class="main-title">ÙØ§ÛŒÙ„ Ù¾Ú©</h1>
        <div class="relative max-w-xl mx-auto mt-4">
            <input type="text" id="mainSearch" oninput="liveSearch()" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ù…ÛŒØ§Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§..." class="glass w-full py-4 px-10 rounded-2xl outline-none text-xl text-center focus:ring-2 ring-blue-500 text-white">
        </div>
    </header>

    <main class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8 min-h-[400px]" id="fileGrid"></main>

    <footer class="max-w-6xl mx-auto glass rounded-[3rem] p-10 mb-12 mt-20 text-center md:text-right border border-white/10 shadow-2xl">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
            <div><div class="text-xl font-black text-sky-400 mb-4">Ø¯Ø±Ø¨Ø§Ø±Ù‡ ÙØ§ÛŒÙ„ Ù¾Ú©</div><p class="text-xs text-gray-400 leading-relaxed">Ù…Ø±Ø¬Ø¹ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ Ù„Ø§ÛŒÙ‡ Ø¨Ø§Ø² Ø¨Ø§ Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ† Ú©ÛŒÙÛŒØª Ø¨Ø±Ø§ÛŒ Ø·Ø±Ø§Ø­Ø§Ù† Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ.</p></div>
            <div><div class="text-xl font-black text-sky-400 mb-4 font-bold">Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø¬Ù…ÙˆØ¹Ù‡</div><p class="text-sm text-white mb-1 font-bold">Ø³ÛŒØ¯ Ø¹Ù„ÛŒ Ø¹Ù„ÙˆÛŒ</p><p class="text-[10px] text-gray-500 uppercase tracking-tighter">Designed by File Pack Â© 2025</p></div>
            <div><div class="text-xl font-black text-sky-400 mb-4 font-bold">Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù…Ø§</div><div class="flex items-center justify-center md:justify-start gap-3"><span class="text-sm text-gray-400">ØªÙ„Ú¯Ø±Ø§Ù…:</span><a href="https://t.me/asedali9903" target="_blank" dir="ltr" class="glass bg-blue-600/10 text-blue-400 px-5 py-2 rounded-xl text-sm font-bold btn-animate border border-blue-500/20 tracking-wide">@asedali9903</a></div></div>
        </div>
    </footer>

    <div id="downloadModal" class="modal p-4">
        <div class="glass max-w-lg w-full p-8 rounded-[3rem] relative">
            <span class="close-btn" onclick="closeModal('downloadModal')">&times;</span>
            <div id="modalMediaContainer" class="w-full h-64 bg-white rounded-3xl mb-8 overflow-hidden border border-white/10 shadow-xl flex items-center justify-center"></div>
            <div class="space-y-3 mb-4 font-bold text-sm" dir="ltr">
                <div class="flex justify-between items-center border-b border-white/5 pb-1"><span class="text-gray-500">File Name:</span><span id="modalFileName" class="text-white ml-4 text-right"></span></div>
                <div class="flex justify-between items-center border-b border-white/5 pb-1"><span class="text-gray-500">File Type:</span><span id="modalFileType" class="text-white ml-4 text-right"></span></div>
                <div class="flex justify-between items-center"><span class="text-gray-500">File Code:</span><span id="modalFileCode" class="text-sky-400 ml-4 font-black text-lg"></span></div>
            </div>
            <div class="text-gray-800 text-center tracking-[0.5em] my-4">-----------------</div>
            <button id="mainDownloadBtn" onclick="processDownload()" class="btn-animate w-full py-5 bg-blue-600 text-white font-bold rounded-2xl shadow-lg">Ø¯Ø§Ù†Ù„ÙˆØ¯</button>
            <p id="limitInfo" class="mt-4 text-center text-[10px] text-gray-500 font-bold"></p>
        </div>
    </div>

    <div id="dashboardModal" class="modal p-4"><div class="admin-panel-bg max-w-6xl w-full p-6 md:p-10 rounded-[3rem] overflow-hidden flex flex-col max-h-[95vh] relative shadow-2xl text-white text-sm text-center"><span class="close-btn" onclick="closeModal('dashboardModal')">&times;</span><h2 class="text-3xl font-black text-blue-400 mb-6 border-b border-blue-500/20 pb-4">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù‡ÙˆØ´Ù…Ù†Ø¯</h2><div class="flex flex-wrap gap-4 mb-6 justify-center"><button onclick="switchTab('users')" id="tabUsers" class="tab-btn active glass px-8 py-2 rounded-xl border border-blue-500/30">Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</button><button onclick="switchTab('files')" id="tabFiles" class="tab-btn glass px-8 py-2 rounded-xl border border-blue-500/30">ÙØ§ÛŒÙ„â€ŒÙ‡Ø§</button><button onclick="sendFullReportToTelegram()" class="bg-orange-600/80 text-white px-6 py-2 rounded-xl border border-orange-500 font-bold hover:bg-orange-500 btn-animate">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ ØªÙ„Ú¯Ø±Ø§Ù…</button></div><div id="sectionUsers" class="overflow-auto flex-1"><table class="w-full text-center"><thead><tr class="text-blue-300"><th>Ø±Ø¯ÛŒÙ</th><th>Ù†Ø§Ù…</th><th>Ø¢ÛŒØ¯ÛŒ</th><th>Ø´Ù…Ø§Ø±Ù‡</th><th>Ø³Ù‚Ù</th><th>ØªØ§Ø±ÛŒØ®Ú†Ù‡</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody id="adminUserTableBody"></tbody></table></div><div id="sectionFiles" class="hidden overflow-auto flex-1 text-sm"><button onclick="openAddFile()" class="mb-4 bg-blue-600 text-white px-6 py-2 rounded-xl font-bold shadow-lg">Ø§ÙØ²ÙˆØ¯Ù† ÙØ§ÛŒÙ„</button><table class="w-full text-center"><thead><tr class="text-blue-300"><th>ID</th><th>Ù†Ø§Ù… ÙØ§ÛŒÙ„</th><th>Ø¯Ø³ØªÙ‡</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody id="adminFileTableBody"></tbody></table></div></div></div>
    <div id="loginModal" class="modal p-4"><div class="glass max-w-sm w-full p-10 rounded-[3rem] relative flex flex-col items-center text-center border-white/10 shadow-2xl"><span class="close-btn" onclick="closeModal('loginModal')">&times;</span><h2 class="text-2xl font-black mb-6 text-blue-400">ÙˆØ±ÙˆØ¯</h2><input type="text" id="loginUser" placeholder="Ø¢ÛŒØ¯ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…" class="glass w-full p-4 rounded-2xl mb-3 outline-none text-center text-white"><input type="text" id="loginPhone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³" class="glass w-full p-4 rounded-2xl mb-6 outline-none text-center text-white"><button onclick="handleUserLogin()" class="btn-animate w-full py-4 bg-blue-600 text-white font-bold rounded-2xl shadow-lg">ÙˆØ±ÙˆØ¯</button><div class="mt-6"><button onclick="closeModal('loginModal'); openModal('signupModal')" class="text-blue-400 text-sm font-bold block">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¬Ø¯ÛŒØ¯</button></div></div></div>
    <div id="signupModal" class="modal p-4"><div class="glass max-w-sm w-full p-10 rounded-[3rem] relative flex flex-col items-center text-center border-white/10 shadow-2xl"><span class="close-btn" onclick="closeModal('signupModal')">&times;</span><h2 class="text-3xl font-black mb-8 text-sky-400">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h2><div class="w-full space-y-4"><input type="text" id="regName" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" class="glass w-full p-4 rounded-2xl outline-none text-center text-white"><input type="text" id="regUser" placeholder="Ø¢ÛŒØ¯ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…" class="glass w-full p-4 rounded-2xl outline-none text-center text-white"><input type="text" id="regPhone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³" class="glass w-full p-4 rounded-2xl outline-none text-center text-white"></div><button onclick="handleUserSignup()" class="btn-animate w-full py-4 mt-8 bg-sky-500 text-black font-extrabold rounded-2xl shadow-lg">Ø¹Ø¶ÙˆÛŒØª Ù†Ù‡Ø§ÛŒÛŒ</button></div></div>
    <div id="adminLoginModal" class="modal p-4"><div class="glass max-w-sm w-full p-8 rounded-[3rem] relative flex flex-col items-center text-center border-blue-500/30 shadow-2xl"><span class="close-btn" onclick="closeModal('adminLoginModal')">&times;</span><h2 class="text-2xl font-black mb-6 text-blue-400">ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±ÛŒØª</h2><input type="text" id="adminUser" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ" class="glass w-full p-4 rounded-2xl mb-3 outline-none text-center text-white"><input type="password" id="adminPass" placeholder="Ø±Ù…Ø² ÙˆØ±ÙˆØ¯" class="glass w-full p-4 rounded-2xl mb-6 outline-none text-center text-white"><button onclick="checkAdminAuth()" class="btn-animate w-full py-4 bg-blue-600 text-white font-bold rounded-2xl shadow-lg">ÙˆØ±ÙˆØ¯</button></div></div>
    <div id="fileFormModal" class="modal p-4"><div class="glass max-w-md w-full p-8 rounded-[3rem] relative overflow-auto max-h-[90vh] text-center border-white/10 shadow-2xl"><span class="close-btn" onclick="closeModal('fileFormModal')">&times;</span><h2 id="fileFormTitle" class="text-2xl font-black mb-6 text-blue-400">Ù…Ø¯ÛŒØ±ÛŒØª ÙØ§ÛŒÙ„</h2><input type="text" id="fTitle" placeholder="File Name" class="glass w-full p-4 rounded-2xl mb-3 outline-none text-white"><input type="text" id="fImg" placeholder="Link (Image/Video)" class="glass w-full p-4 rounded-2xl mb-3 outline-none text-left text-white"><textarea id="fDesc" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª" class="glass w-full p-4 rounded-2xl mb-3 outline-none h-24 text-white text-center"></textarea><input type="text" id="fLink" placeholder="Download URL" class="glass w-full p-4 rounded-2xl mb-3 outline-none text-left text-white"><input type="text" id="fCat" placeholder="File Type" class="glass w-full p-4 rounded-2xl mb-6 outline-none text-white text-center"><button onclick="saveFile()" class="btn-animate w-full py-4 bg-blue-600 text-white font-bold rounded-2xl shadow-lg">Ø°Ø®ÛŒØ±Ù‡</button></div></div>
    <div id="historyModal" class="modal p-4"><div class="admin-panel-bg max-w-2xl w-full p-8 rounded-[3rem] relative flex flex-col max-h-[85vh]"><span class="close-btn" onclick="closeModal('historyModal')">&times;</span><h2 class="text-2xl font-black mb-6 text-blue-400 text-center border-b border-blue-500/20 pb-4 text-white font-bold">ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¯Ø§Ù†Ù„ÙˆØ¯</h2><div id="historyContent" class="overflow-auto flex-1 pr-2 text-right"></div></div></div>
    <div id="editUserModal" class="modal p-4"><div class="admin-panel-bg max-w-sm w-full p-8 rounded-[3rem] relative text-center border-blue-500/20 shadow-2xl"><span class="close-btn" onclick="closeModal('editUserModal')">&times;</span><h2 class="text-2xl font-black mb-6 text-blue-400 text-white font-bold text-lg">Ø³Ù‚Ù Ø¯Ø§Ù†Ù„ÙˆØ¯</h2><input type="number" id="editLimit" class="glass w-full p-4 rounded-2xl mb-6 outline-none text-center font-bold text-sky-400"><button onclick="saveUserEdit()" class="btn-animate w-full py-4 bg-blue-600 text-white font-bold rounded-2xl shadow-lg">Ø«Ø¨Øª</button></div></div>

    <script>
        const BOT_TOKEN = '7900019888:AAE1svoVvUbbFvqNM0AL4S7-ow-Wt2n6yy8';
        const MY_CHAT_ID = '5971023799';
        const ADMIN_USER = 'asedali9903';
        const ADMIN_PASS = '1234567891';

        let users = JSON.parse(localStorage.getItem('filepack_users') || '[]');
        let files = JSON.parse(localStorage.getItem('filepack_files') || '[]');
        let currentUser = JSON.parse(localStorage.getItem('filepack_session'));
        let editingFileIndex = null, editingUserIndex = null;
        let activeDownloadLink = ""; // Ù…ØªØºÛŒØ± Ø°Ø®ÛŒØ±Ù‡ Ù„ÛŒÙ†Ú© ÙØ¹Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯

        const fixNumbers = (str) => str.toString().replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d)).replace(/[Ù -Ù©]/g, d => 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d));

        function initApp() { renderHomeFiles(); updateUserUI(); }
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { 
            document.getElementById(id).classList.remove('active'); 
            if(id === 'downloadModal') { document.getElementById('modalMediaContainer').innerHTML = ''; activeDownloadLink = ""; }
        }

        function isVideo(url) { return /\.(mp4|webm|ogg|mov)$/i.test(url); }

        function renderHomeFiles() {
            const grid = document.getElementById('fileGrid'); grid.innerHTML = '';
            files.forEach((f, index) => {
                let mediaHtml = isVideo(f.img) 
                    ? `<video src="${f.img}" class="w-full h-full object-contain" muted loop onmouseover="this.play()" onmouseout="this.pause()"></video>`
                    : `<img src="${f.img}" class="w-full h-full object-contain group-hover:scale-105 transition duration-500">`;

                grid.innerHTML += `<div class="glass p-5 rounded-[2.5rem] file-item cursor-pointer group hover:border-blue-500 transition-all text-center" onclick="openDownloadModal(${index})">
                    <div class="w-full h-48 bg-white rounded-2xl mb-4 overflow-hidden shadow-inner border border-white/5 flex items-center justify-center">${mediaHtml}</div>
                    <div class="text-[10px] text-gray-500 mb-1 font-bold uppercase text-white">CODE: ${f.id}</div>
                    <h3 class="font-bold text-lg mb-2 text-white">${f.title}</h3>
                    <p class="text-[11px] text-blue-400 font-bold mt-4 flex items-center justify-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                        Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯
                    </p>
                </div>`;
            });
        }

        function openDownloadModal(index) {
            const f = files[index];
            document.getElementById('modalFileName').innerText = f.title;
            document.getElementById('modalFileType').innerText = f.cat || 'General';
            document.getElementById('modalFileCode').innerText = f.id;
            activeDownloadLink = f.link; // Ø°Ø®ÛŒØ±Ù‡ Ù„ÛŒÙ†Ú© ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ
            
            const container = document.getElementById('modalMediaContainer');
            container.innerHTML = isVideo(f.img) 
                ? `<video src="${f.img}" class="w-full h-full object-contain" controls autoplay></video>`
                : `<img src="${f.img}" class="w-full h-full object-contain">`;

            if(currentUser) {
                const today = new Intl.DateTimeFormat('fa-IR').format(new Date());
                const count = (currentUser.lastDate === today) ? (currentUser.dailyHistory ? currentUser.dailyHistory.length : 0) : 0;
                document.getElementById('limitInfo').innerText = `Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ù…Ø±ÙˆØ²: ${count} Ø§Ø² ${currentUser.customLimit || 5}`;
            }
            openModal('downloadModal');
        }

        function processDownload() {
            if(!currentUser) { closeModal('downloadModal'); openModal('loginModal'); return; }
            if(!activeDownloadLink || activeDownloadLink === "#" || activeDownloadLink === "") { return alert("Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª."); }

            const today = new Intl.DateTimeFormat('fa-IR').format(new Date());
            const fileName = document.getElementById('modalFileName').innerText;
            const fileCode = document.getElementById('modalFileCode').innerText;
            const timeNow = new Intl.DateTimeFormat('fa-IR', { dateStyle: 'medium', timeStyle: 'short' }).format(new Date());

            if (currentUser.lastDate !== today) { currentUser.dailyHistory = []; currentUser.lastDate = today; }
            
            if (!currentUser.dailyHistory.includes(fileCode)) {
                if (currentUser.dailyHistory.length >= (currentUser.customLimit || 5)) return alert(`âŒ Ø³Ù‚Ù Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø±ÙˆØ²Ø§Ù†Ù‡ ØªÙ…Ø§Ù… Ø´Ø¯.`);
                currentUser.dailyHistory.push(fileCode);
            }
            
            currentUser.detailedHistory.push({ name: fileName, code: fileCode, time: timeNow });
            let idx = users.findIndex(x => x.phone === currentUser.phone);
            users[idx] = currentUser;
            localStorage.setItem('filepack_users', JSON.stringify(users));
            localStorage.setItem('filepack_session', JSON.stringify(currentUser));
            
            // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¯Ø± ØªØ¨ Ø¬Ø¯ÛŒØ¯ (Ø§ØµÙ„Ø§Ø­ Ø§ØµÙ„ÛŒ)
            window.open(activeDownloadLink, '_blank');
            
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: MY_CHAT_ID, text: `ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…ÙˆÙÙ‚: ${currentUser.name} | ÙØ§ÛŒÙ„: ${fileName}` }) });
            alert('Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªØ§ÛŒÛŒØ¯ Ø´Ø¯ Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¢ØºØ§Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯.');
        }

        window.addEventListener('scroll', () => {
            const btnText = document.getElementById('scrollText');
            const btnIcon = document.getElementById('scrollIcon');
            if (window.scrollY > 300) { btnText.innerText = 'Ø¨Ø±ÛŒÙ… Ø¨Ø§Ù„Ø§'; btnIcon.classList.remove('rotate-180'); }
            else { btnText.innerText = 'Ø¨Ø±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ†'; btnIcon.classList.add('rotate-180'); }
        });

        function toggleScroll() {
            if (window.scrollY > 300) window.scrollTo({ top: 0, behavior: 'smooth' });
            else window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        function switchTab(tab) {
            document.getElementById('sectionUsers').classList.toggle('hidden', tab !== 'users');
            document.getElementById('sectionFiles').classList.toggle('hidden', tab !== 'files');
            document.getElementById('tabUsers').classList.toggle('active', tab === 'users');
            document.getElementById('tabFiles').classList.toggle('active', tab === 'files');
            if(tab === 'users') renderAdminUserTable(); else renderAdminFileTable();
        }

        function renderAdminUserTable() {
            const tbody = document.getElementById('adminUserTableBody'); tbody.innerHTML = '';
            users.forEach((u, i) => {
                const countToday = (new Intl.DateTimeFormat('fa-IR').format(new Date()) === u.lastDate) ? (u.dailyHistory ? u.dailyHistory.length : 0) : 0;
                tbody.innerHTML += `<tr><td>${i+1}</td><td>${u.name}</td><td class="text-blue-400 font-bold">@${u.telegram}</td><td class="text-gray-400 text-xs">${u.phone}</td><td class="text-sky-400 font-bold">${countToday}/${u.customLimit || 5}</td><td><button onclick="showHistory(${i})" class="text-blue-400 underline">ØªØ§Ø±ÛŒØ®Ú†Ù‡</button></td><td><button onclick="openEditUser(${i})" class="text-white bg-blue-600 px-3 py-1 rounded-lg text-xs btn-animate">ÙˆÛŒØ±Ø§ÛŒØ´</button></td></tr>`;
            });
        }

        function showHistory(index) {
            const u = users[index]; const container = document.getElementById('historyContent'); container.innerHTML = '';
            if (!u.detailedHistory || u.detailedHistory.length === 0) container.innerHTML = '<p class="text-center text-gray-500 mt-10">Ø®Ø§Ù„ÛŒ</p>';
            else [...u.detailedHistory].reverse().forEach((item, i) => { container.innerHTML += `<div class="history-card text-white text-right"><div class="flex flex-col gap-1 w-full"><span class="font-bold text-sm text-white">${u.detailedHistory.length - i}. ${item.name}</span><span class="text-[10px] text-gray-400 tracking-tight">Ú©Ø¯: ${item.code} | Ø²Ù…Ø§Ù†: ${item.time}</span></div></div>`; });
            openModal('historyModal');
        }

        function handleUserLogin() {
            const u = fixNumbers(document.getElementById('loginUser').value.trim().replace('@',''));
            const p = fixNumbers(document.getElementById('loginPhone').value.trim());
            const found = users.find(x => x.telegram.toLowerCase() === u.toLowerCase() && x.phone === p);
            if(found) { localStorage.setItem('filepack_session', JSON.stringify(found)); location.reload(); } else alert('ÛŒØ§ÙØª Ù†Ø´Ø¯!');
        }

        function handleUserSignup() {
            const name = document.getElementById('regName').value.trim();
            const tUser = fixNumbers(document.getElementById('regUser').value.trim().replace('@',''));
            const tPhone = fixNumbers(document.getElementById('regPhone').value.trim());
            if(!name || !tUser || !tPhone) return alert('Ù‡Ù…Ù‡ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
            if(users.some(x => x.phone === tPhone || x.telegram.toLowerCase() === tUser.toLowerCase())) return alert('ØªÚ©Ø±Ø§Ø±ÛŒ!');
            users.push({ name, telegram: tUser, phone: tPhone, lastDate: '', customLimit: 5, dailyHistory: [], detailedHistory: [] });
            localStorage.setItem('filepack_users', JSON.stringify(users));
            alert('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚!'); closeModal('signupModal'); openModal('loginModal');
        }

        function checkAdminAuth() {
            const u = fixNumbers(document.getElementById('adminUser').value.trim());
            const p = fixNumbers(document.getElementById('adminPass').value.trim());
            if(u === ADMIN_USER && p === ADMIN_PASS) { closeModal('adminLoginModal'); switchTab('users'); openModal('dashboardModal'); } else alert('Ø®Ø·Ø§!');
        }

        function sendFullReportToTelegram() {
            let msg = "ğŸ“Š **Ú¯Ø²Ø§Ø±Ø´ Ø¬Ø§Ù…Ø¹ ÙØ§ÛŒÙ„ Ù¾Ú©**\n\nğŸ‘¥ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:\n";
            if (users.length === 0) msg += "_Ø®Ø§Ù„ÛŒ_";
            else users.forEach((u, i) => msg += `${i+1}. ${u.name} | @${u.telegram} | ${u.phone}\n`);
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: MY_CHAT_ID, text: msg }) });
            alert('Ú¯Ø²Ø§Ø±Ø´ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.');
        }

        function renderAdminFileTable() {
            const tbody = document.getElementById('adminFileTableBody'); tbody.innerHTML = '';
            files.forEach((f, i) => { tbody.innerHTML += `<tr><td>#${f.id}</td><td class="font-bold text-white text-right">${f.title}</td><td>${f.cat}</td><td><button onclick="editFile(${i})" class="text-sky-400 ml-3 btn-animate">ÙˆÛŒØ±Ø§ÛŒØ´</button><button onclick="deleteFile(${i})" class="text-red-400 btn-animate text-xs">Ø­Ø°Ù</button></td></tr>`; });
        }

        function openEditUser(i) { editingUserIndex = i; document.getElementById('editLimit').value = users[i].customLimit || 5; openModal('editUserModal'); }
        function saveUserEdit() { users[editingUserIndex].customLimit = parseInt(document.getElementById('editLimit').value); localStorage.setItem('filepack_users', JSON.stringify(users)); closeModal('editUserModal'); renderAdminUserTable(); }
        function openAddFile() { editingFileIndex = null; document.getElementById('fTitle').value = ''; document.getElementById('fImg').value = ''; document.getElementById('fDesc').value = ''; document.getElementById('fLink').value = ''; document.getElementById('fCat').value = ''; openModal('fileFormModal'); }
        function saveFile() {
            const data = { title: document.getElementById('fTitle').value, img: document.getElementById('fImg').value, desc: document.getElementById('fDesc').value, link: document.getElementById('fLink').value, cat: document.getElementById('fCat').value };
            if(editingFileIndex !== null) files[editingFileIndex] = { ...files[editingFileIndex], ...data }; else files.push({ ...data, id: files.length + 1 });
            files = files.map((f, i) => ({ ...f, id: i + 1 })); localStorage.setItem('filepack_files', JSON.stringify(files)); closeModal('fileFormModal'); renderAdminFileTable(); renderHomeFiles();
        }
        function deleteFile(i) { if(confirm('Ø­Ø°ÙØŸ')) { files.splice(i, 1); files = files.map((f, i) => ({ ...f, id: i + 1 })); localStorage.setItem('filepack_files', JSON.stringify(files)); renderAdminFileTable(); renderHomeFiles(); } }
        function editFile(i) { editingFileIndex = i; const f = files[i]; document.getElementById('fTitle').value = f.title; document.getElementById('fImg').value = f.img; document.getElementById('fDesc').value = f.desc; document.getElementById('fLink').value = f.link; document.getElementById('fCat').value = f.cat; openModal('fileFormModal'); }
        function liveSearch() { let val = document.getElementById('mainSearch').value.toLowerCase(); let items = document.getElementsByClassName('file-item'); for(let item of items) item.style.display = item.innerText.toLowerCase().includes(val) ? "block" : "none"; }
        function updateUserUI() { if(currentUser) { document.getElementById('userStatusBtn').innerText = 'Ø®Ø±ÙˆØ¬'; document.getElementById('userGreeting').innerText = `Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ØŒ ${currentUser.name}`; document.getElementById('userGreeting').classList.remove('hidden'); } }
        document.getElementById('userStatusBtn').addEventListener('click', () => { if(currentUser) { localStorage.removeItem('filepack_session'); location.reload(); } });
    </script>
</body>
</html>
